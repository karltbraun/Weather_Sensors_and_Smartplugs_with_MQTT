# Weather Sensors MQTT Stack for Portainer
# Copy this entire file content into Portainer > Stacks > Add Stack > Web Editor
# This file is GENERATED from portainer-stack.template.yml - DO NOT EDIT DIRECTLY

# =============================================================================
# Configuration:
#   PUB_SOURCE: TWIX
#   Network Mode: host
#   DEPLOYMENT_SCENARIO: host-networking
# =============================================================================

# Weather Sensors MQTT Stack for Portainer - TEMPLATE
# DO NOT EDIT THIS FILE DIRECTLY - Use generate-portainer-stacks.sh
# This template is used to generate deployment-specific stack files

# =============================================================================
# This template generates stack files for different deployment scenarios:
#   - portainer-stack.yml: Home lab deployment (bridge networking)
#   - portainer-stack-vultr2.yml: Vultr VM deployment (host networking)
# =============================================================================

###############################################################################
# NETWORK CONFIGURATION
###############################################################################

networks:
  weather-sensors:
    driver: bridge
    name: weather-sensors-network

volumes:
  sensor-data:
    name: weather-sensors-data
    driver: local
  sensor-logs:
    name: weather-sensors-logs
    driver: local
  sensor-config:
    name: weather-sensors-config
    driver: local

###############################################################################
# SENSOR REPUBLISHER SERVICE
# Services section for the weather sensors republishing service
###############################################################################

services:
  # RTL-433 Sensor Data Republisher Service
  sensor-republisher:
    image: karltbraun/weather-sensors:latest
    pull_policy: always
    container_name: weather-sensors-republisher
    restart: on-failure:3
    ###############################################################################
    # NETWORK CONFIGURATION
    # Host networking enabled
    #   - 'network_mode: host' is active
    #   - 'networks:' is commented out
    # To use bridge networking instead:
    #   - Comment 'network_mode: host'
    #   - Uncomment 'networks: - weather-sensors'
    ###############################################################################
    network_mode: host
    # networks:
      # - weather-sensors
    volumes:
      - sensor-data:/app/data
      - sensor-logs:/app/logs
      - sensor-config:/app/config
    ###############################################################################
    # ENVIRONMENT VARIABLES
    # Configuration for TWIX
    #  BROKER_NAME=n-vultr2
    #  PUB_SOURCE=TWIX
    #  network_mode=host
    ###############################################################################
    environment:
      - DEPLOYMENT_SCENARIO=host-networking
      - PUB_SOURCE=TWIX
      # PUB_SOURCE is set to TWIX for this deployment
      - BROKER_NAME=n-vultr2
      - TZ=America/Los_Angeles
      - PUBLISH_INTERVAL_MAX=60
      - SERVICE=republish
      - CONSOLE_LOG_LEVEL=INFO
      - FILE_LOG_LEVEL=DEBUG
      - CLEAR_LOG_FILE=true
      - MQTT_CONFIG_INFO={}
      - PUB_TOPIC_ROOT=KTBMES
      - SUB_TOPICS_REPUBLISH=+/sensors/raw/#,KTBMES/sensors/config/local_sensors/update
      - MQTT_TOPIC_LOCAL_SENSORS_UPDATES=KTBMES/sensors/config/local_sensors/update
      - MQTT_TOPIC_LOCAL_SENSORS_CURRENT=KTBMES/sensors/config/local_sensors/current
      - CONFIG_SUBSCRIBE_TIMEOUT=10
      - MAX_BACKUPS=10
      - BACKUP_RETENTION_DAYS=30
    labels:
      - "portainer.group=weather-sensors"
      - "portainer.service=republisher"
      - "description=RTL-433 sensor data republisher service"
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/logs/republish_processed_sensors.log') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.1'


###############################################################################
# SHELLY ENERGY MONITOR PROCESSOR SERVICE
# Services section for the shelly-processor servce
###############################################################################

  # Shelly Smart Device Processor Service
  shelly-processor:
    image: karltbraun/weather-sensors:latest
    pull_policy: always
    container_name: shelly-processor
    restart: on-failure:3
    ###############################################################################
    # NETWORK CONFIGURATION
    # Host networking enabled
    #   - 'network_mode: host' is active
    #   - 'networks:' is commented out
    # To use bridge networking instead:
    #   - Comment 'network_mode: host'
    #   - Uncomment 'networks: - weather-sensors'
    ###############################################################################
    network_mode: host
    # networks:
      # - weather-sensors
    volumes:
      - sensor-data:/app/data
      - sensor-logs:/app/logs
      - sensor-config:/app/config
    ###############################################################################
    # ENVIRONMENT VARIABLES
    # Configuration for TWIX
    #  BROKER_NAME=n-vultr2
    #  PUB_SOURCE=TWIX
    #  network_mode=host
    ###############################################################################
    environment:
      - DEPLOYMENT_SCENARIO=host-networking
      - PUB_SOURCE=TWIX
      - BROKER_NAME=n-vultr2
      - TZ=America/Los_Angeles
      - SERVICE=shelly
      - CONSOLE_LOG_LEVEL=INFO
      - FILE_LOG_LEVEL=DEBUG
      - CLEAR_LOG_FILE=true
      - MQTT_CONFIG_INFO={}
      - PUB_TOPIC_ROOT=KTBMES
      - SUB_TOPICS_SHELLY=Shelly/#
    labels:
      - "portainer.group=weather-sensors"
      - "portainer.service=shelly-processor"
      - "description=Shelly smart device processor service"
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/logs/shelly.log') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.1'
